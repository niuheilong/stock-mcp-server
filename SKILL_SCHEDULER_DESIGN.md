# ğŸ¯ OpenClaw æŠ€èƒ½è°ƒåº¦ä¸ä¼˜åŒ–ç³»ç»Ÿ
# Skill Scheduler & Cost Optimization System

## ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆç¬¬ä¸€æ€§åŸç†ï¼‰

### 1.1 ç¬¬ä¸€æ€§åŸç†
```
æ ¸å¿ƒé—®é¢˜ï¼šç”¨æˆ·éœ€è¦ä»€ä¹ˆï¼Ÿ
â†“
ä¸æ˜¯"æˆ‘èƒ½åšä»€ä¹ˆ"ï¼Œè€Œæ˜¯"ä»€ä¹ˆæœ€æœ‰æ•ˆè§£å†³é—®é¢˜"
â†“
æœ€å°æˆæœ¬ â†’ æœ€å¿«é€Ÿåº¦ â†’ æœ€ä½³ç»“æœ
```

### 1.2 æˆæœ¬æ•ˆç›ŠåŸåˆ™
| æ“ä½œ | Tokenæˆæœ¬ | æ—¶é—´æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|-----------|----------|----------|
**æœ¬åœ°è®¡ç®—** | â­ æä½ | â­â­ å¿« | æ•°æ®å¤„ç†ã€æ ¼å¼åŒ–
**æ–‡ä»¶è¯»å–** | â­ æä½ | â­â­ å¿« | å·²æœ‰æ•°æ®ã€ç¼“å­˜
**Web Fetch** | â­â­ ä½ | â­â­â­ ä¸­ç­‰ | é™æ€é¡µé¢
**Web Search** | â­â­â­ ä¸­ | â­â­â­â­ æ…¢ | éœ€è¦æ–°ä¿¡æ¯
**Browser** | â­â­â­â­ é«˜ | â­â­â­â­â­ å¾ˆæ…¢ | åŠ¨æ€ç½‘ç«™ã€äº¤äº’
**AIç”Ÿæˆ** | â­â­â­â­â­ æé«˜ | â­â­â­â­ æ…¢ | åˆ›æ„ã€åˆ†æã€æ€»ç»“

---

## äºŒã€æŠ€èƒ½ä¼˜å…ˆçº§æ¶æ„

### 2.1 ä¼˜å…ˆçº§é‡‘å­—å¡”

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Layer 5   â”‚  AIç”Ÿæˆ/å¤æ‚åˆ†æ
                    â”‚  (æœ€é«˜æˆæœ¬) â”‚  Tokenæ˜‚è´µï¼Œè°¨æ…ä½¿ç”¨
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Layer 4   â”‚  Web Browser
                    â”‚  (é«˜æˆæœ¬)   â”‚  äº¤äº’å¼ã€åŠ¨æ€å†…å®¹
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Layer 3   â”‚  Web Search/Fetch
                    â”‚ (ä¸­ç­‰æˆæœ¬)  â”‚  ä¿¡æ¯è·å–
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Layer 2   â”‚  æ–‡ä»¶/ç¼“å­˜/æœ¬åœ°å·¥å…·
                    â”‚  (ä½æˆæœ¬)   â”‚  å¿«é€Ÿã€å¯é 
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Layer 1   â”‚  æœ¬åœ°è®¡ç®—/å·²æœ‰æ•°æ®
                    â”‚  (æœ€ä½æˆæœ¬) â”‚  ä¼˜å…ˆä½¿ç”¨
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è°ƒåº¦ç­–ç•¥

```python
# æ ¸å¿ƒè°ƒåº¦é€»è¾‘
class SkillScheduler:
    def execute_task(self, task):
        # 1. å…ˆå°è¯•Layer 1-2ï¼ˆæœ¬åœ°ï¼‰
        if self.can_solve_with_local(task):
            return self.use_local_tools(task)
        
        # 2. å°è¯•Layer 3ï¼ˆç½‘ç»œé™æ€ï¼‰
        if self.can_solve_with_fetch(task):
            return self.use_web_fetch(task)
        
        # 3. å°è¯•Layer 4ï¼ˆæµè§ˆå™¨ï¼‰
        if self.need_browser_interaction(task):
            return self.use_browser(task)
        
        # 4. æœ€åä½¿ç”¨Layer 5ï¼ˆAIï¼‰
        return self.use_ai_generation(task)
```

---

## ä¸‰ã€å…·ä½“æŠ€èƒ½çŸ©é˜µ

### 3.1 è‚¡ç¥¨åˆ†æåœºæ™¯

| éœ€æ±‚ | ä¼˜å…ˆçº§ | é¦–é€‰å·¥å…· | Fallback | é¿å…ä½¿ç”¨ |
|------|--------|----------|----------|----------|
**å®æ—¶è‚¡ä»·** | 1 | sina_stock_api.py | qq_stock_api.py | Browserè®¿é—®ä¸œè´¢ |
**å†å²Kçº¿** | 2 | akshareï¼ˆç¼“å­˜ï¼‰ | Tushare | Web scraping |
**æ–°é—»æƒ…ç»ª** | 3 | Jina Reader | Web Search | Browserç‚¹å‡» |
**æŠ€æœ¯æŒ‡æ ‡** | 1 | æœ¬åœ°è®¡ç®— | - | äº‘ç«¯API |
**æ·±åº¦åˆ†æ** | 5 | AIç”Ÿæˆ | - | - |

### 3.2 ç½‘é¡µè·å–åœºæ™¯

| éœ€æ±‚ | ä¼˜å…ˆçº§ | é¦–é€‰ | Fallback | é¿å… |
|------|--------|------|----------|------|
**é™æ€é¡µé¢** | 2 | web_fetch | Jina Reader | Browser |
**åçˆ¬ä¸¥é‡** | 3 | Jina Reader | Browser | é‡å¤å°è¯• |
**éœ€è¦äº¤äº’** | 4 | Browser | - | - |
**ç™»å½•é™åˆ¶** | 4 | Browser+Cookie | - | æ— å¤´æµè§ˆå™¨ |

### 3.3 ä¿¡æ¯æœç´¢åœºæ™¯

| éœ€æ±‚ | ä¼˜å…ˆçº§ | é¦–é€‰ | Fallback | é¿å… |
|------|--------|------|----------|------|
**å·²çŸ¥URL** | 1 | web_fetch | - | Web Search |
**ç‰¹å®šä¿¡æ¯** | 2 | Web Search | web_fetchå¤šé¡µ | Browseréå† |
**å®æ—¶æ–°é—»** | 3 | Web Search | Jina RSS | - |
**æ·±åº¦ç ”ç©¶** | 5 | AIæ€»ç»“ | - | äººå·¥é˜…è¯» |

---

## å››ã€Fallbackï¼ˆè¡¥ä½ï¼‰æœºåˆ¶

### 4.1 è‡ªåŠ¨é™çº§ç­–ç•¥

```python
def get_stock_data(symbol):
    """è·å–è‚¡ç¥¨æ•°æ®ï¼Œå¤šå±‚fallback"""
    
    # Level 1: æ–°æµªAPIï¼ˆæœ€å¿«ï¼‰
    try:
        return sina_api.get_price(symbol)
    except:
        log("Level 1 failed, trying Level 2...")
    
    # Level 2: è…¾è®¯APIï¼ˆå¤‡ç”¨ï¼‰
    try:
        return qq_api.get_price(symbol)
    except:
        log("Level 2 failed, trying Level 3...")
    
    # Level 3: Jina ReaderæŠ“å–
    try:
        page = jina_reader.fetch(f"https://quote.eastmoney.com/{symbol}")
        return extract_price_from_page(page)
    except:
        log("Level 3 failed, trying Level 4...")
    
    # Level 4: Browserï¼ˆæœ€åæ‰‹æ®µï¼‰
    try:
        return browser_get_price(symbol)
    except:
        return {"error": "All methods failed"}
```

### 4.2 è¶…æ—¶æ§åˆ¶

```python
# æ¯å±‚è®¾ç½®ä¸åŒè¶…æ—¶
TIMEOUT_CONFIG = {
    "local_calculation": 1,      # 1ç§’
    "file_read": 2,              # 2ç§’
    "web_fetch": 5,              # 5ç§’
    "web_search": 10,            # 10ç§’
    "browser": 30,               # 30ç§’
    "ai_generation": 60,         # 60ç§’
}
```

---

## äº”ã€æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### 5.1 Tokenæˆæœ¬æ§åˆ¶

| ç­–ç•¥ | èŠ‚çœ | å®æ–½æ–¹æ³• |
|------|------|----------|
**ç»“æœç¼“å­˜** | 50-80% | ç¼“å­˜web fetchç»“æœ5åˆ†é’Ÿ |
**æ‰¹å¤„ç†** | 30-50% | åˆå¹¶å¤šä¸ªå°è¯·æ±‚ |
**ç²¾ç®€Prompt** | 20-40% | ç§»é™¤ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡ |
**æœ¬åœ°é¢„å¤„ç†** | 60-90% | æ•°æ®æ¸…æ´—åœ¨æœ¬åœ°å®Œæˆ |

### 5.2 æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

```python
class SmartCache:
    """æ™ºèƒ½ç¼“å­˜ - æ ¹æ®æ•°æ®ç±»å‹è®¾ç½®ä¸åŒTTL"""
    
    CACHE_TTL = {
        "stock_price": 60,        # è‚¡ä»·: 1åˆ†é’Ÿ
        "stock_info": 3600,       # è‚¡ç¥¨ä¿¡æ¯: 1å°æ—¶
        "web_page": 300,          # ç½‘é¡µ: 5åˆ†é’Ÿ
        "news": 600,              # æ–°é—»: 10åˆ†é’Ÿ
        "search_result": 1800,    # æœç´¢ç»“æœ: 30åˆ†é’Ÿ
        "analysis_report": 86400, # åˆ†ææŠ¥å‘Š: 1å¤©
    }
```

---

## å…­ã€å®é™…åº”ç”¨ç¤ºä¾‹

### 6.1 è‚¡ç¥¨åˆ†æä¼˜åŒ–æµç¨‹

```
ç”¨æˆ·: "åˆ†æè´µå·èŒ…å°"

ä¼˜åŒ–å‰ï¼ˆé«˜æˆæœ¬ï¼‰:
1. Browseræ‰“å¼€ä¸œè´¢ â†’ 30ç§’
2. AIè¯»å–é¡µé¢åˆ†æ â†’ 2000 tokens
3. Web searchæ‰¾æ–°é—» â†’ 1500 tokens
4. AIæ€»ç»“æ–°é—» â†’ 1000 tokens
æ€»è®¡: 4500 tokens, 60ç§’

ä¼˜åŒ–åï¼ˆä½æˆæœ¬ï¼‰:
1. æœ¬åœ°APIè·å–è‚¡ä»· â†’ 0 tokens, 0.5ç§’
2. Jina ReaderæŠ“å–æ–°é—» â†’ 0 tokens, 3ç§’
3. æœ¬åœ°å…³é”®è¯ç»Ÿè®¡ â†’ 0 tokens, 0.1ç§’
4. æ ¼å¼åŒ–è¾“å‡º â†’ 100 tokens, 0.1ç§’
æ€»è®¡: 100 tokens, 4ç§’

èŠ‚çœ: 98% token, 93% æ—¶é—´
```

### 6.2 æŠ€èƒ½é…åˆç¤ºä¾‹

```python
# ä¼˜åŒ–ï¼šå¤šæ™ºèƒ½ä½“è‚¡ç¥¨åˆ†æ
class OptimizedStockAnalyzer:
    def analyze(self, symbol):
        # å¹¶è¡Œè·å–æ•°æ®ï¼ˆæœ¬åœ°+ç½‘ç»œï¼‰
        with ThreadPoolExecutor() as executor:
            price_future = executor.submit(sina_api.get_price, symbol)
            news_future = executor.submit(jina_reader.fetch_news, symbol)
        
        price_data = price_future.result()
        news_data = news_future.result()
        
        # æœ¬åœ°åˆ†æï¼ˆä¸è°ƒç”¨AIï¼‰
        sentiment = self.local_sentiment_analysis(news_data)
        technical = self.local_technical_analysis(price_data)
        
        # åªæœ‰éœ€è¦æ·±åº¦åˆ†ææ—¶æ‰ç”¨AI
        if self.need_deep_analysis(price_data):
            return self.ai_comprehensive_analysis(price_data, news_data)
        else:
            return self.format_local_result(price_data, sentiment, technical)
```

---

## ä¸ƒã€å®æ–½æ¸…å•

### ç«‹å³å®æ–½ï¼ˆé«˜ROIï¼‰

- [ ] 1. ä¸ºweb fetchæ·»åŠ 5åˆ†é’Ÿç¼“å­˜
- [ ] 2. è‚¡ä»·æŸ¥è¯¢ä½¿ç”¨æœ¬åœ°APIä¼˜å…ˆ
- [ ] 3. åˆ†æç»“æœæœ¬åœ°æ ¼å¼åŒ–ï¼ˆä¸ç”¨AIï¼‰
- [ ] 4. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

### çŸ­æœŸå®æ–½ï¼ˆä¸­ROIï¼‰

- [ ] 5. å®ç°æŠ€èƒ½ä¼˜å…ˆçº§è°ƒåº¦å™¨
- [ ] 6. æ‰¹é‡å¤„ç†ç›¸ä¼¼è¯·æ±‚
- [ ] 7. ç¼“å­˜æœç´¢å…³é”®è¯ç»“æœ

### é•¿æœŸä¼˜åŒ–ï¼ˆæˆ˜ç•¥æ€§ï¼‰

- [ ] 8. å»ºç«‹æœ¬åœ°çŸ¥è¯†åº“
- [ ] 9. é¢„æµ‹æ€§æ•°æ®é¢„åŠ è½½
- [ ] 10. è‡ªé€‚åº”æˆæœ¬æ§åˆ¶ç³»ç»Ÿ

---

## å…«ã€ç›‘æ§æŒ‡æ ‡

```
å…³é”®æŒ‡æ ‡:
- Tokenæ¶ˆè€—/æ¬¡è¯·æ±‚
- å¹³å‡å“åº”æ—¶é—´
- Cacheå‘½ä¸­ç‡
- Fallbackè§¦å‘ç‡
- ç”¨æˆ·æ»¡æ„åº¦

ç›®æ ‡:
- Tokenæˆæœ¬é™ä½ 70%
- å“åº”æ—¶é—´ < 5ç§’
- Cacheå‘½ä¸­ç‡ > 60%
```

---

**ç°åœ¨å¼€å§‹å®æ–½ï¼Ÿå…ˆåˆ›å»ºæ™ºèƒ½è°ƒåº¦å™¨ï¼Ÿ** ğŸš€
